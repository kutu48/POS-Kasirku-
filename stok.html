<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Laporan Stok | Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="js/tailwindcss.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Loader Universal -->
  <div id="loader" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white px-8 py-4 rounded shadow text-lg font-semibold flex items-center gap-3">
      <svg class="animate-spin h-7 w-7 text-blue-600" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
      </svg>
      <span id="loaderText">Memuat data stok...</span>
    </div>
  </div>
  <!-- Header & Navbar -->
  <header class="w-full bg-blue-600 text-white text-center shadow-md py-5">
    <h1 class="text-2xl md:text-3xl font-bold mb-1">KasirKu Dashboard</h1>
    <p class="opacity-90 text-base">Monitoring Inventory Live</p>
  </header>
  <nav class="w-full bg-white shadow flex items-center justify-between px-2 md:px-10 py-2 sticky top-0 z-50">
    <div class="flex items-center gap-1 md:gap-4">
      <a href="index.html" class="flex flex-col items-center text-blue-600 hover:text-blue-800 px-2 py-1 md:py-0 font-medium transition group">
        <svg class="w-6 h-6 mb-1 group-hover:scale-105" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24">
          <path d="M3 12l9-9 9 9" /><path d="M9 21V9h6v12" />
        </svg>
        <span class="text-xs md:text-[15px]">Home</span>
      </a>
      <a href="penerimaan.html" class="flex flex-col items-center text-blue-600 hover:text-blue-800 px-2 py-1 md:py-0 font-medium transition group">
        <svg class="w-6 h-6 mb-1 group-hover:scale-105" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24">
          <path d="M12 3v12" /><path d="M12 15l-4-4" /><path d="M12 15l4-4" /><rect x="3" y="17" width="18" height="4" rx="2"/>
        </svg>
        <span class="text-xs md:text-[15px]">Penerimaan</span>
      </a>
      <a href="pengeluaran.html" class="flex flex-col items-center text-blue-600 hover:text-blue-800 px-2 py-1 md:py-0 font-medium transition group">
        <svg class="w-6 h-6 mb-1 group-hover:scale-105" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24">
          <path d="M12 21V9" /><path d="M12 9l4 4" /><path d="M12 9l-4 4" /><rect x="3" y="3" width="18" height="4" rx="2"/>
        </svg>
        <span class="text-xs md:text-[15px]">Pengeluaran</span>
      </a>
      <a href="laporan.html" class="flex flex-col items-center text-blue-600 hover:text-blue-800 px-2 py-1 md:py-0 font-medium transition group">
        <svg class="w-6 h-6 mb-1 group-hover:scale-105" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24">
          <path d="M3 3v18h18" /><rect x="7" y="12" width="2" height="6"/><rect x="11" y="8" width="2" height="10"/><rect x="15" y="5" width="2" height="13"/>
        </svg>
        <span class="text-xs md:text-[15px]">Laporan Transaksi</span>
      </a>
      <a href="stok.html" class="flex flex-col items-center text-blue-600 hover:text-blue-800 px-2 py-1 md:py-0 font-medium transition group">
        <svg class="w-6 h-6 mb-1 group-hover:scale-105" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24">
          <polygon points="12 2 22 7 12 12 2 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>
        </svg>
        <span class="text-xs md:text-[15px]">Laporan Stok</span>
      </a>
    </div>
  </nav>
  
  <!-- DASHBOARD -->
  <section class="max-w-5xl mx-auto grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm mt-8 mb-6">
    <div class="rounded-2xl shadow bg-blue-50 p-4 text-center">
      <div class="text-gray-600 mb-1">Total Produk</div>
      <div id="statTotalBarang" class="font-bold text-2xl text-blue-700">-</div>
    </div>
    <div class="rounded-2xl shadow bg-green-50 p-4 text-center">
      <div class="text-gray-600 mb-1">Total Qty</div>
      <div id="statTotalQty" class="font-bold text-2xl text-green-700">-</div>
    </div>
    <div class="rounded-2xl shadow bg-amber-50 p-4 text-center">
      <div class="text-gray-600 mb-1">Total Modal</div>
      <div id="statTotalModal" class="font-bold text-xl text-amber-700">-</div>
    </div>
    <div class="rounded-2xl shadow bg-purple-50 p-4 text-center">
      <div class="text-gray-600 mb-1">Potensi Omzet</div>
      <div id="statTotalOmzet" class="font-bold text-xl text-purple-700">-</div>
    </div>
  </section>
  <!-- Statistik sisa stok -->
  <div id="infoExtraStat" class="max-w-5xl mx-auto mb-2 text-xs"></div>

  <!-- FILTER -->
  <div class="max-w-5xl mx-auto flex flex-col md:flex-row items-center gap-3 px-2 mb-2">
    <label class="w-full md:w-1/3 text-sm font-medium">Cari produk/qty/harga:
      <input id="filterInput" type="text" class="border border-gray-300 rounded px-3 py-2 mt-1 w-full outline-blue-400" placeholder="Filter produk, qty, kode, harga...">
    </label>
  </div>
  <div class="max-w-5xl mx-auto flex flex-col md:flex-row items-center justify-between gap-3 px-2 my-2">
  <div class="flex items-center gap-2 text-sm">
    <label for="perPage" class="font-medium">Tampilkan</label>
    <select id="perPage" class="border px-2 py-1 rounded">
      <option>10</option>
      <option selected>20</option>
      <option>50</option>
      <option>100</option>
      <option value="ALL">ALL</option>
    </select>
    <span>produk</span>
  </div>
  <div id="pagingPanel" class="flex items-center gap-2 text-sm"></div>
</div>

  <!-- TABEL STOK -->
  <div class="overflow-x-auto max-w-5xl mx-auto shadow rounded-lg bg-white">
    <table class="w-full text-sm">
      <thead>
        <tr class="bg-blue-100 text-blue-900">
          <th class="p-2">Kode Barang</th>
          <th class="p-2">Nama Barang</th>
          <th class="p-2">Satuan</th>
          <th class="p-2 text-right">QTY Awal</th>
          <th class="p-2 text-right">QTY Sisa</th>
          <th class="p-2 text-right">Harga Beli</th>
          <th class="p-2 text-right">Harga Jual</th>
          <th class="p-2">Tanggal Masuk</th>
          <th class="p-2 text-right">Subtotal</th>
        </tr>
      </thead>
      <tbody id="stokTableBody">
        <tr><td colspan="9" class="text-center text-gray-400 py-7">Memuat data...</td></tr>
      </tbody>
    </table>
  </div>

<script>
const API_STOK = "https://opensheet.elk.sh/1qOzg1n30vBfwmw1_/Penerimaan";
let stokData = [], filteredStok = [];
let page = 1, perPage = 20;

function showLoading(msg) {
  document.getElementById('loaderText').textContent = msg || "Loading...";
  document.getElementById('loader').classList.remove('hidden');
}
function hideLoading() {
  document.getElementById('loader').classList.add('hidden');
}
function formatRupiah(num) {
  return "Rp " + Number(num||0).toLocaleString("id-ID");
}
function renderStatistik() {
  let data = filteredStok;
  let u = new Set(data.map(r=>r.kode)), tp=u.size;
  let tqa = data.reduce((a,b)=>a+(b.qtyAwal||0),0);
  let tma = data.reduce((a,b)=>a+((b.qtyAwal||0)*(b.hargaBeli||0)),0);
  let toa = data.reduce((a,b)=>a+((b.qtyAwal||0)*(b.hargaJual||0)),0);
  let tms = data.reduce((a,b)=>a+((b.qtySisa||0)*(b.hargaBeli||0)),0);
  let tos = data.reduce((a,b)=>a+((b.qtySisa||0)*(b.hargaJual||0)),0);
  document.getElementById('statTotalBarang').textContent=tp;
  document.getElementById('statTotalQty').textContent=tqa;
  document.getElementById('statTotalModal').textContent=formatRupiah(tma);
  document.getElementById('statTotalOmzet').textContent=formatRupiah(toa);
  document.getElementById('infoExtraStat').innerHTML = `
    <div class="text-gray-700 mt-2">
      <b>Total Modal Sisa Stok:</b> <span class="text-amber-700">${formatRupiah(tms)}</span>
      &nbsp;&nbsp;|&nbsp;&nbsp;
      <b>Potensi Omzet Sisa Stok:</b> <span class="text-purple-700">${formatRupiah(tos)}</span>
    </div>`;
}

function renderTabel() {
  const tb = document.getElementById('stokTableBody');
  if (!filteredStok.length) {
    tb.innerHTML = '<tr><td colspan="9" class="text-center text-gray-400 py-5">Tidak ada data...</td></tr>';
    return;
  }
  let start = (page - 1) * perPage;
  let end = perPage ? start + perPage : filteredStok.length;
  let rows = filteredStok.slice(start, end);
  let html = "";
  rows.forEach(row => {
    html += `<tr>
      <td class="border-b p-2">${row.kode}</td>
      <td class="border-b p-2">${row.nama}</td>
      <td class="border-b p-2">${row.satuan}</td>
      <td class="border-b p-2 text-right">${row.qtyAwal}</td>
      <td class="border-b p-2 text-right">${row.qtySisa}</td>
      <td class="border-b p-2 text-right">${formatRupiah(row.hargaBeli)}</td>
      <td class="border-b p-2 text-right">${formatRupiah(row.hargaJual)}</td>
      <td class="border-b p-2">${row.tglDatang}</td>
      <td class="border-b p-2 text-right">${formatRupiah(row.subtotal)}</td>
    </tr>`;
  });
  tb.innerHTML = html;
}
function renderPaging() {
  let panel = document.getElementById('pagingPanel');
  let total = filteredStok.length;
  let totalPage = Math.max(1, Math.ceil(total / perPage));
  if (perPage >= total) { panel.innerHTML = ""; return; }
  panel.innerHTML = `
    <button class="px-2 py-1 rounded bg-blue-100 hover:bg-blue-200" ${page<=1?'disabled':''} onclick="prevPage()">Prev</button>
    <span class="mx-1">Page <b>${page}</b> / ${totalPage}</span>
    <button class="px-2 py-1 rounded bg-blue-100 hover:bg-blue-200" ${page>=totalPage?'disabled':''} onclick="nextPage()">Next</button>
  `;
}
window.prevPage = function() {
  if (page > 1) page--;
  renderTabel();
  renderPaging();
};
window.nextPage = function() {
  let total = filteredStok.length;
  let totalPage = Math.max(1, Math.ceil(total / perPage));
  if (page < totalPage) page++;
  renderTabel();
  renderPaging();
};

function filterStok(keyword) {
  keyword = (keyword || "").toLowerCase();
  filteredStok = stokData.filter(row =>
    (row.kode||"").toLowerCase().includes(keyword) ||
    (row.nama||"").toLowerCase().includes(keyword) ||
    (row.satuan||"").toLowerCase().includes(keyword) ||
    String(row.qtyAwal).includes(keyword) ||
    String(row.qtySisa).includes(keyword) ||
    String(row.hargaBeli).includes(keyword) ||
    String(row.hargaJual).includes(keyword)
  );
}

document.getElementById('filterInput').oninput = function() {
  filterStok(this.value);
  page = 1;
  renderStatistik();
  renderTabel();
  renderPaging();
};

document.getElementById('perPage').onchange = function() {
  let val = this.value;
  if (val === "ALL") {
    perPage = filteredStok.length || 99999;
    page = 1;
  } else {
    perPage = Number(val) || 20;
    page = 1;
  }
  renderTabel();
  renderPaging();
};

async function loadStok() {
  showLoading("Memuat data stok...");
  try {
    const res = await fetch(API_STOK);
    const raw = await res.json();
    stokData = raw.map(row=>({
      kode:row["Kode Barang"],
      nama:row["Nama Barang"],
      satuan:row["Satuan "],
      qtyAwal:Number(row["qty awal"]||row["qty_awal"]||row["QTY AWAL"]||0),
      qtySisa:Number(row["qty sisa"]||row["qty_sisa"]||row["QTY SISA"]||0),
      hargaBeli:Number(row["harga beli"]||row["HARGA BELI"]||row.hargaBeli||0),
      hargaJual:Number(row["harga jual"]||row["HARGA JUAL"]||row.hargaJual||0),
      tglDatang:row["tanggal masuk"],
      subtotal:Number(row["sub total"]||row["SUB TOTAL"]||row.subtotal||0)
    }));
    filterStok(""); // Reset filter
    page = 1;
    renderStatistik();
    renderTabel();
    renderPaging();
  } catch (e) {
    document.getElementById('stokTableBody').innerHTML = '<tr><td colspan="9" class="text-center text-red-400 py-5">Gagal memuat data</td></tr>';
  }
  hideLoading();
}
loadStok();
</script>
</body>
</html>
